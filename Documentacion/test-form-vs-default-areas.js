const fetch = require('node-fetch');

// Configuraci√≥n
const API_BASE_URL = 'http://localhost:5000/api';
let token = null;
let areaFormularioId = null;
let areaPredefinidaId = null;

// Funci√≥n para hacer login y obtener token
async function login() {
  try {
    console.log('Iniciando sesi√≥n como administrador...');
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        email: 'admin@sistema.com',
        password: 'Admin123456'
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.data && data.data.token) {
      console.log('‚úÖ Login exitoso');
      return data.data.token;
    } else {
      console.error('‚ùå Error al hacer login:', data.error || 'No se recibi√≥ token');
      return null;
    }
  } catch (error) {
    console.error('‚ùå Error en la petici√≥n de login:', error.message);
    return null;
  }
}

// 1. Crear un √°rea mediante formulario (similar a como lo har√≠a el usuario)
async function crearAreaPorFormulario() {
  try {
    console.log('\nüîπ Creando √°rea mediante formulario (simulando frontend)...');
    
    // Datos que se enviar√≠an desde un formulario web
    const formData = {
      name: `√Årea Formulario ${Date.now()}`,
      description: 'Esta √°rea fue creada mediante formulario web',
      icon: 'folder',
      color: '#FF5722',
      // No enviamos isDefault porque normalmente el formulario no lo incluir√≠a
    };
    
    console.log('Datos del formulario:', formData);
    
    const response = await fetch(`${API_BASE_URL}/areas`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    console.log(`Status: ${response.status} ${response.statusText}`);
    
    if (data.success && data.data) {
      console.log('‚úÖ √Årea creada correctamente mediante formulario');
      console.log('ID:', data.data._id);
      console.log('Nombre:', data.data.name);
      console.log('¬øEs predefinida?', data.data.isDefault ? 'S√≠' : 'No');
      areaFormularioId = data.data._id;
      return data.data;
    } else {
      console.error('‚ùå Error al crear el √°rea por formulario:', data.error || 'Error desconocido');
      return null;
    }
  } catch (error) {
    console.error('‚ùå Error en la petici√≥n para crear √°rea por formulario:', error.message);
    return null;
  }
}

// 2. Crear un √°rea predefinida
async function crearAreaPredefinida() {
  try {
    console.log('\nüîπ Creando √°rea predefinida...');
    
    const response = await fetch(`${API_BASE_URL}/areas/default`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({})
    });
    
    const data = await response.json();
    console.log(`Status: ${response.status} ${response.statusText}`);
    
    if (data.success && data.data && data.data.length > 0) {
      console.log(`‚úÖ √Åreas predefinidas creadas: ${data.data.length}`);
      // Tomar la primera √°rea creada para las pruebas
      const areaPredefinida = data.data[0];
      console.log('ID:', areaPredefinida._id);
      console.log('Nombre:', areaPredefinida.name);
      console.log('¬øEs predefinida?', areaPredefinida.isDefault ? 'S√≠' : 'No');
      areaPredefinidaId = areaPredefinida._id;
      return areaPredefinida;
    } else if (response.status === 500) {
      console.log('‚ÑπÔ∏è Las √°reas predefinidas ya existen. Obteniendo √°reas existentes...');
      // Obtener √°reas existentes y seleccionar una predefinida
      const areas = await obtenerAreas();
      const areasPredefinidas = areas.filter(area => area.isDefault === true);
      
      if (areasPredefinidas.length > 0) {
        const areaPredefinida = areasPredefinidas[0];
        console.log('ID:', areaPredefinida._id);
        console.log('Nombre:', areaPredefinida.name);
        console.log('¬øEs predefinida?', areaPredefinida.isDefault ? 'S√≠' : 'No');
        areaPredefinidaId = areaPredefinida._id;
        return areaPredefinida;
      } else {
        console.error('‚ùå No se encontraron √°reas predefinidas');
        return null;
      }
    } else {
      console.error('‚ùå Error al crear √°reas predefinidas:', data.error || 'Error desconocido');
      return null;
    }
  } catch (error) {
    console.error('‚ùå Error en la petici√≥n para crear √°reas predefinidas:', error.message);
    return null;
  }
}

// 3. Obtener todas las √°reas
async function obtenerAreas() {
  try {
    console.log('\nüîπ Obteniendo lista de √°reas...');
    
    const response = await fetch(`${API_BASE_URL}/areas`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const data = await response.json();
    console.log(`Status: ${response.status} ${response.statusText}`);
    
    if (data.success && data.data) {
      console.log(`‚úÖ Se encontraron ${data.count} √°reas`);
      
      // Informar cu√°ntas √°reas son predefinidas y cu√°ntas son manuales
      const areasPredefinidas = data.data.filter(area => area.isDefault === true);
      const areasManual = data.data.filter(area => !area.isDefault);
      
      console.log(`- √Åreas predefinidas: ${areasPredefinidas.length}`);
      console.log(`- √Åreas por formulario: ${areasManual.length}`);
      
      // Mostrar detalles de cada √°rea
      console.log('\nListado de √°reas:');
      data.data.forEach(area => {
        console.log(`- ${area.name} (${area._id}) - Predefinida: ${area.isDefault ? 'S√≠' : 'No'}`);
      });
      
      return data.data;
    } else {
      console.error('‚ùå Error al obtener √°reas:', data.error || 'Error desconocido');
      return [];
    }
  } catch (error) {
    console.error('‚ùå Error en la petici√≥n para obtener √°reas:', error.message);
    return [];
  }
}

// 4. Eliminar un √°rea espec√≠fica
async function eliminarArea(areaId, esPredefinida) {
  try {
    console.log(`\nüîπ Eliminando √°rea ${esPredefinida ? 'predefinida' : 'de formulario'}: ${areaId}...`);
    
    // Hacer la petici√≥n exactamente como lo har√≠a el frontend
    const response = await fetch(`${API_BASE_URL}/areas/${areaId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    // Capturar la respuesta completa para an√°lisis
    const responseText = await response.text();
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (e) {
      data = { success: false, error: { message: 'Respuesta no es JSON v√°lido' } };
    }
    
    console.log(`‚ÑπÔ∏è Status: ${response.status} ${response.statusText}`);
    console.log(`‚ÑπÔ∏è Respuesta completa:`, responseText);
    
    if (response.status === 200 && data.success) {
      console.log(`‚úÖ √Årea eliminada correctamente`);
      return true;
    } else if (response.status === 404) {
      console.error(`‚ùå Error 404: √Årea no encontrada`);
      return false;
    } else {
      console.error(`‚ùå Error al eliminar √°rea:`, data.error || 'Error desconocido');
      return false;
    }
  } catch (error) {
    console.error(`‚ùå Error en la petici√≥n para eliminar √°rea:`, error.message);
    return false;
  }
}

// 5. Verificar si un √°rea existe
async function verificarAreaExiste(areaId) {
  try {
    console.log(`\nüîπ Verificando si el √°rea ${areaId} existe...`);
    
    const response = await fetch(`${API_BASE_URL}/areas/${areaId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (response.status === 200) {
      const data = await response.json();
      console.log(`‚úÖ El √°rea existe y est√° activa`);
      console.log(`Detalles: ${data.data.name} - Predefinida: ${data.data.isDefault ? 'S√≠' : 'No'}`);
      return true;
    } else if (response.status === 404) {
      console.log(`‚ÑπÔ∏è El √°rea no existe o est√° inactiva`);
      return false;
    } else {
      const data = await response.json();
      console.log(`‚ÑπÔ∏è Status: ${response.status}, Mensaje: ${data.error?.message || 'Desconocido'}`);
      return false;
    }
  } catch (error) {
    console.error(`‚ùå Error al verificar existencia del √°rea:`, error.message);
    return false;
  }
}

// 6. Funci√≥n principal para ejecutar las pruebas
async function ejecutarPruebas() {
  console.log('üî∂ INICIANDO PRUEBAS ESPECIALIZADAS DE ELIMINACI√ìN DE √ÅREAS üî∂');
  
  // 1. Hacer login
  token = await login();
  if (!token) {
    console.error('‚ùå No se pudo obtener token. Abortando pruebas.');
    return;
  }
  
  // 2. Ver √°reas iniciales
  await obtenerAreas();
  
  // 3. Crear un √°rea mediante formulario
  const areaFormulario = await crearAreaPorFormulario();
  
  // 4. Crear o seleccionar un √°rea predefinida
  const areaPredefinida = await crearAreaPredefinida();
  
  if (!areaFormulario || !areaPredefinida) {
    console.error('‚ùå No se pudo crear al menos una de las √°reas necesarias. Abortando...');
    return;
  }
  
  // 5. Verificar √°reas actuales
  await obtenerAreas();
  
  // 6. Verificar existencia espec√≠fica de ambas √°reas
  await verificarAreaExiste(areaFormularioId);
  await verificarAreaExiste(areaPredefinidaId);
  
  // 7. Eliminar el √°rea predefinida
  let eliminacionPredefinidaExitosa = false;
  if (areaPredefinidaId) {
    eliminacionPredefinidaExitosa = await eliminarArea(areaPredefinidaId, true);
    // Verificar si realmente se elimin√≥
    const existeDespuesDeEliminar = await verificarAreaExiste(areaPredefinidaId);
    if (eliminacionPredefinidaExitosa && existeDespuesDeEliminar) {
      console.log('‚ö†Ô∏è ADVERTENCIA: El √°rea predefinida sigue apareciendo despu√©s de eliminarla');
    } else if (eliminacionPredefinidaExitosa && !existeDespuesDeEliminar) {
      console.log('‚úÖ Confirmado: El √°rea predefinida fue eliminada correctamente');
    }
  }
  
  // 8. Eliminar el √°rea de formulario
  let eliminacionFormularioExitosa = false;
  if (areaFormularioId) {
    eliminacionFormularioExitosa = await eliminarArea(areaFormularioId, false);
    // Verificar si realmente se elimin√≥
    const existeDespuesDeEliminar = await verificarAreaExiste(areaFormularioId);
    if (eliminacionFormularioExitosa && existeDespuesDeEliminar) {
      console.log('‚ö†Ô∏è ADVERTENCIA: El √°rea de formulario sigue apareciendo despu√©s de eliminarla');
    } else if (eliminacionFormularioExitosa && !existeDespuesDeEliminar) {
      console.log('‚úÖ Confirmado: El √°rea de formulario fue eliminada correctamente');
    }
  }
  
  // 9. Verificar √°reas finales
  await obtenerAreas();
  
  // 10. Resumen
  console.log('\nüî∂ RESUMEN DE LAS PRUEBAS üî∂');
  console.log(`√Årea predefinida: ${eliminacionPredefinidaExitosa ? '‚úÖ Eliminada' : '‚ùå Error al eliminar'}`);
  console.log(`√Årea por formulario: ${eliminacionFormularioExitosa ? '‚úÖ Eliminada' : '‚ùå Error al eliminar'}`);
  
  console.log('\nüî∂ FIN DE LAS PRUEBAS üî∂');
}

// Ejecutar las pruebas
ejecutarPruebas().catch(err => {
  console.error('‚ùå Error general en las pruebas:', err);
}); 